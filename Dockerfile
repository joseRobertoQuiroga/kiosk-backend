# ═══════════════════════════════════════════════════════════════
# 🚀 DOCKERFILE PARA API NESTJS - KIOSKO SYSTEM (CON CLI)
# ═══════════════════════════════════════════════════════════════

# ═══════════════════════════════════════════════════════════════
# Etapa 1: Build
# ═══════════════════════════════════════════════════════════════
FROM node:20-alpine AS builder

WORKDIR /app

# ─────────────────────────────────────────────────────────────
# 📦 INSTALAR DEPENDENCIAS DE LA API
# ─────────────────────────────────────────────────────────────
COPY package*.json ./
RUN npm install

# ─────────────────────────────────────────────────────────────
# 📦 COPIAR Y COMPILAR LA API
# ─────────────────────────────────────────────────────────────
COPY . .
RUN echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" && \
    echo "🔨 Compilando API..." && \
    npm run build && \
    ls -la dist/ && \
    echo "✅ API compilada"

# ─────────────────────────────────────────────────────────────
# 📦 COMPILAR EL CLI (SI EXISTE)
# ─────────────────────────────────────────────────────────────
RUN if [ -d "cli" ]; then \
        echo "━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━" && \
        echo "🔨 Compilando CLI..." && \
        cd cli && \
        npm install && \
        npm run build && \
        ls -la dist/ && \
        echo "✅ CLI compilado" && \
        cd ..; \
    else \
        echo "⚠️  Carpeta cli/ no encontrada, omitiendo..."; \
    fi

# ═══════════════════════════════════════════════════════════════
# Etapa 2: Production
# ═══════════════════════════════════════════════════════════════
FROM node:20-alpine AS production

WORKDIR /app

# ─────────────────────────────────────────────────────────────
# 📦 INSTALAR DEPENDENCIAS DE PRODUCCIÓN DE LA API
# ─────────────────────────────────────────────────────────────
COPY package*.json ./
RUN npm install --only=production && npm cache clean --force

# ─────────────────────────────────────────────────────────────
# 📂 COPIAR API COMPILADA
# ─────────────────────────────────────────────────────────────
COPY --from=builder /app/dist ./dist

# ─────────────────────────────────────────────────────────────
# 📂 COPIAR CLI COMPLETO (con dependencias)
# ─────────────────────────────────────────────────────────────
COPY --from=builder /app/cli ./cli

# ─────────────────────────────────────────────────────────────
# 📁 CREAR DIRECTORIOS NECESARIOS
# ─────────────────────────────────────────────────────────────
RUN mkdir -p /app/public/imagenes /app/uploads/videos

# ─────────────────────────────────────────────────────────────
# 🌐 EXPONER PUERTO
# ─────────────────────────────────────────────────────────────
EXPOSE 3000

# ─────────────────────────────────────────────────────────────
# ⚙️ VARIABLES DE ENTORNO
# ─────────────────────────────────────────────────────────────
ENV NODE_ENV=production
ENV PORT=3000

# ─────────────────────────────────────────────────────────────
# 🚀 COMANDO DE INICIO
# ─────────────────────────────────────────────────────────────
CMD ["sh", "-c", "node dist/main.js || node dist/src/main.js || node dist/main"]